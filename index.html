<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FogCast Lite ‚Äì v0.8.5 (deploy diagnostics)</title>
  <meta name="description" content="10-day fog risk forecast with hourly breakdown and sunrise/sunset (24h). Uses Open-Meteo; no API key required.">
  <style>
    :root{ --bg:#0b0f14; --card:#111827; --muted:#6b7280; --text:#e5e7eb; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --info:#3b82f6; --err:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b0f14,#0d1320);color:var(--text);font:15px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:1000px;margin:20px auto;padding:0 14px}
    header{display:flex;gap:10px;align-items:center;margin-bottom:10px}
    .logo{width:34px;height:34px;border-radius:10px;background:#121a2a;display:grid;place-items:center}
    h1{font-size:18px;margin:0}
    .panel{background:var(--card);border:1px solid #1f2937;padding:12px;border-radius:14px;box-shadow:0 6px 24px #0003;margin-bottom:12px}
    .controls{display:grid;grid-template-columns:1fr auto auto auto;gap:8px;align-items:center}
    input[type="text"]{background:#0a1220;border:1px solid #1f2937;color:var(--text);padding:10px 12px;border-radius:10px;outline:none}
    .btn{background:#6d28d9;border:none;color:white;padding:10px 12px;border-radius:10px;font-weight:600;cursor:pointer}
    .btn.geo{background:#1d4ed8}
    .btn.ghost{background:transparent;border:1px solid #273245;color:#cbd5e1}
    .small{font-size:12px;color:#9ca3af}
    .days{display:flex;gap:12px;overflow-x:auto;padding-bottom:6px;scroll-snap-type:x mandatory}
    .days::-webkit-scrollbar{height:8px}.days::-webkit-scrollbar-thumb{background:#253046;border-radius:999px}
    .day{min-width:230px;max-width:250px;scroll-snap-align:start;background:linear-gradient(180deg,#0e1626,#0b121d);border:1px solid #1f2433;border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:8px;cursor:pointer}
    .day.selected{border-color:#3b82f6;box-shadow:0 0 0 2px #1e3a8a66 inset}
    .muted{color:var(--muted);font-size:12px}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid #2a3344;background:#0a1220}
    .bar{height:8px;border-radius:6px;background:#111827;border:1px solid #1f2937;overflow:hidden}
    .bar > span{display:block;height:100%;width:0%}
    .risk{font-weight:700}.risk.low{color:var(--ok)}.risk.med{color:var(--warn)}.risk.high{color:var(--bad)}
    .mini-hourly{display:grid;grid-template-columns:28px 1fr;gap:6px;align-items:center;margin-top:6px}
    .mini-hourly .ticks{display:grid;grid-template-rows:repeat(24,1fr);gap:2px}
    .mini-hourly .ticks div{font-size:10px;color:#9ca3af;text-align:right;opacity:.9}
    .mini-hourly .cols{display:grid;grid-template-rows:repeat(24,1fr);gap:2px}
    .mini-hourly .hbar{height:8px;border:1px solid #213047;background:#0a1220;border-radius:4px;overflow:hidden}
    .mini-hourly .hbar span{display:block;height:100%;width:0}
    .hourly{display:grid;grid-template-columns:repeat(24,1fr);gap:5px;align-items:end;margin-top:8px}
    .hourly .bar{height:90px;border:1px solid #1f2937;background:#0b1220;display:flex;align-items:flex-end;border-radius:6px;overflow:hidden}
    .hourly .bar span{width:100%}
    .axis{display:grid;grid-template-columns:repeat(24,1fr);gap:5px;margin-top:6px}
    .axis .tick{font-size:10px;color:#9ca3af;text-align:center}
    .sunaxis{margin-top:4px}
    .geo-banner{display:flex;align-items:center;justify-content:space-between;gap:10px;background:#0a1220;border:1px solid #223047;color:#cbd5e1;padding:10px 12px;border-radius:10px;margin-bottom:10px}
    .status{background:#0a1220;border:1px solid #1f2937;padding:10px;border-radius:10px;margin-top:8px}
    .status .ok{color:var(--ok)} .status .info{color:var(--info)} .status .err{color:var(--err)}
    @media (max-width:760px){.controls{grid-template-columns:1fr auto auto}.day{min-width:86vw;max-width:88vw}#desktopHourly{display:none}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">üå´Ô∏è</div>
      <div><h1>FogCast Lite ‚Ä¢ 10-Day Fog Risk</h1><div class="small">Open-Meteo only ‚Ä¢ sunrise/sunset (24h)</div></div>
    </header>

    <section class="panel">
      <div id="geoBanner" class="geo-banner" hidden>
        <div>Use your location for faster local forecast?</div>
        <div style="display:flex;gap:6px">
          <button class="btn geo" id="geoAllow">Yes</button>
          <button class="btn ghost" id="geoDismiss">Not now</button>
        </div>
      </div>
      <div class="controls">
        <input id="location" type="text" placeholder="Enter a place (e.g., Sheffield, UK)" value="Sheffield, UK" />
        <button class="btn" id="go">Get 10-Day</button>
        <button class="btn geo" id="useGeo" title="Use my location">üìç</button>
        <button class="btn ghost" id="selfTest">Run self‚Äëcheck</button>
      </div>
      <div class="small">Type a city and press ‚ÄúGet 10‚ÄëDay‚Äù. If it fails, use the self‚Äëcheck to see what‚Äôs wrong.</div>
      <div id="status" class="status small" role="status" aria-live="polite"></div>
    </section>

    <section class="panel">
      <div class="small">Scroll horizontally. Each card shows a vertical hourly chart (00‚Äì23) and ‚Üë/‚Üì times.</div>
      <div id="days" class="days" role="list"></div>
    </section>

    <section id="desktopHourly" class="panel" aria-live="polite">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><div id="hourTitle" style="font-weight:700">Select a day above</div><div id="hourSubtitle" class="small"></div></div>
        <div class="small">Legend: <span style="color:var(--ok)">Low</span> ‚Ä¢ <span style="color:var(--warn)">Med</span> ‚Ä¢ <span style="color:var(--bad)">High</span></div>
      </div>
      <div id="hourGrid" class="hourly" aria-hidden="true"></div>
      <div id="hourAxis" class="axis"></div>
      <div id="sunAxis" class="axis sunaxis"></div>
    </section>

    <section class="panel small">
      Build <span id="buildId"></span> ‚Ä¢ <span id="buildHash" class="small"></span>
    </section>
  </div>

  <script>
  const Build = { id:'v0.8.5-lite', ts:new Date().toISOString(), hash:(Math.random().toString(36).slice(2,8)).toUpperCase(), model:'fogProbLite 1.0' };
  document.getElementById('buildId').textContent = Build.id;
  document.getElementById('buildHash').textContent = Build.hash;

  const _cache=new Map();
  const GEO_PROMPTED='fogcast.geo.prompted';
  const GEO_APPROVED='fogcast.geo.approved';
  const statusBox = document.getElementById('status');

  function tell(cls,msg){ const line=document.createElement('div'); line.className=cls; line.textContent=msg; statusBox.appendChild(line); }
  function clearStatus(){ statusBox.innerHTML=''; }

  function clamp01(x){return Math.min(1,Math.max(0,x))}
  function sigmoid(z){return 1/(1+Math.exp(-z))}
  function fmtHM(d, tz){ if(!d) return null; try{ return new Intl.DateTimeFormat(undefined,{hour:'2-digit',minute:'2-digit',hour12:false,timeZone:tz||undefined}).format(d); }catch(e){ return d.toLocaleTimeString().slice(0,5);} }
  function fmtSun(sr, ss, tz){ return { sr, ss, srStr: sr?fmtHM(sr,tz):'‚Äî', ssStr: ss?fmtHM(ss,tz):'‚Äî' }; }
  function formatDayLabel(d){return d.toLocaleDateString(undefined,{weekday:'short', month:'short', day:'numeric'})}
  function riskClass(p){return p>=0.7?'high':(p>=0.4?'med':'low')}
  function riskIcon(p){return p>=0.7?'üå´Ô∏è':(p>=0.4?'‚òÅÔ∏è':'‚òÄÔ∏è')}

  const W={base:-2.2,rh:0.05,spread:-0.5,calm:0.6,breeze:0.15,windy:0.25,lowCloud:0.012,press:0.01,night:0.7,freeze:0.25};
  function fogProb({t,td,rh,wind,lowCloud,pressure,hour}){
    const spread=(t!=null&&td!=null)?(t-td):null;
    const _rh=rh ?? (spread!=null ? clamp01(1 - spread/20)*100 : null);
    const night=(hour>=21||hour<=6)?1:0;
    const nearFreezing=(t!=null&&t<=2)?1:0;
    let z=W.base;
    if(_rh!=null) z+=W.rh*(_rh-85);
    if(spread!=null) z+=W.spread*Math.min(4,Math.max(-2,spread));
    if(wind!=null){ if(wind<=3) z+=W.calm; else if(wind<=6) z+=W.breeze; else z-=W.windy*(wind-6)/4; }
    if(lowCloud!=null) z+=W.lowCloud*(lowCloud-40);
    if(pressure!=null) z+=W.press*(pressure-1015);
    z+=night*W.night+nearFreezing*W.freeze;
    return clamp01(sigmoid(z));
  }

  async function geocodePlace(q){
    const url=\`https://geocoding-api.open-meteo.com/v1/search?name=\${encodeURIComponent(q)}&count=1&language=en&format=json\`;
    const r=await fetch(url,{mode:'cors'}).then(r=>r.json()).catch(e=>{ throw new Error('Network/blocked geocoding'); });
    const g=r?.results?.[0];
    if(!g) throw new Error('Place not found');
    return {lat:g.latitude, lon:g.longitude, label:\`\${g.name}\${g.admin1?', '+g.admin1:''}\${g.country?', '+g.country:''}\`, timezone:g.timezone};
  }

  async function openMeteo({lat,lon,timezone}){
    const key=\`om:\${lat.toFixed(3)},\${lon.toFixed(3)}\`; const now=Date.now(); const c=_cache.get(key); if(c&&now-c.ts<5*60*1000) return c.data;
    const params=new URLSearchParams({
      latitude:lat, longitude:lon, timezone:timezone||'auto', forecast_days:'10',
      hourly:['temperature_2m','dew_point_2m','relative_humidity_2m','wind_speed_10m','cloud_cover_low','surface_pressure'].join(','),
      daily:['sunrise','sunset'].join(','), timeformat:'iso8601'
    });
    const url=\`https://api.open-meteo.com/v1/forecast?\${params}\`;
    const json=await fetch(url,{mode:'cors'}).then(r=>r.json()).catch(e=>{ throw new Error('Network/blocked forecast'); });
    if(!json?.hourly?.time) throw new Error('Open-Meteo: missing hourly');
    const H=json.hourly; const to=(a,i)=> (a&&a[i]!=null? Number(a[i]):null);
    const map=new Map();
    for(let i=0;i<H.time.length;i++){
      const tISO=H.time[i]; const d=new Date(tISO);
      const di=Math.floor((d.setHours(0,0,0,0)-(new Date()).setHours(0,0,0,0))/86400000); if(di<0||di>9) continue;
      const hour=new Date(tISO).getHours();
      const p=fogProb({ t:to(H.temperature_2m,i), td:to(H.dew_point_2m,i), rh:to(H.relative_humidity_2m,i), wind:to(H.wind_speed_10m,i), lowCloud:to(H.cloud_cover_low,i), pressure:to(H.surface_pressure,i), hour });
      if(!map.has(di)) map.set(di, Array(24).fill(null)); map.get(di)[hour]=p;
    }
    for(const [di,arr] of map.entries()){
      let last=0.2; for(let h=0;h<24;h++){ if(arr[h]==null) arr[h]=last; else last=arr[h]; }
      for(let h=22;h>=0;h--){ if(arr[h]==null) arr[h]=arr[h+1]; }
      for(let h=1;h<23;h++){ arr[h]=(arr[h-1]+arr[h]+arr[h+1])/3; }
    }
    const D=json.daily||{}; const SR=D.sunrise||[]; const SS=D.sunset||[];
    function getSun(i){ const sr=SR[i]?new Date(SR[i]):null; const ss=SS[i]?new Date(SS[i]):null; return fmtSun(sr,ss,timezone); }
    const out={ key:'openmeteo', label:'Open-Meteo', getDay:(i)=>map.get(i), getSun };
    _cache.set(key,{ts:now,data:out}); return out;
  }

  function renderHourly(locLabel, date, hourlyArr, provider){
    const title=document.getElementById('hourTitle');
    const sub=document.getElementById('hourSubtitle');
    const grid=document.getElementById('hourGrid');
    const axis=document.getElementById('hourAxis');
    const sunAxis=document.getElementById('sunAxis');
    title.textContent = \`\${formatDayLabel(date)} ‚Äì \${locLabel}\`;
    const peak=Math.max(...hourlyArr); const peakH=hourlyArr.indexOf(peak);
    sub.textContent = \`Peak \${String(peakH).padStart(2,'0')}:00 ¬∑ \${Math.round(peak*100)}%\`;
    grid.innerHTML='';
    hourlyArr.forEach((p,h)=>{
      const bar=document.createElement('div'); bar.className='bar';
      const span=document.createElement('span');
      span.style.height=(Math.max(0.05,p)*100)+'%';
      span.style.background=p>=0.7?'var(--bad)':(p>=0.4?'var(--warn)':'var(--ok)');
      span.title=\`\${String(h).padStart(2,'0')}:00 ‚Äî \${Math.round(p*100)}%\`;
      bar.appendChild(span); grid.appendChild(bar);
    });
    grid.removeAttribute('aria-hidden');
    axis.innerHTML=''; for(let h=0;h<24;h++){ const t=document.createElement('div'); t.className='tick'; t.textContent=String(h).padStart(2,'0'); axis.appendChild(t); }
    sunAxis.innerHTML='';
    const di = Math.floor((new Date(date).setHours(0,0,0,0)-(new Date()).setHours(0,0,0,0))/86400000);
    const sun = provider.getSun ? provider.getSun(di) : {srStr:'‚Äî',ssStr:'‚Äî'};
    const srH = sun.sr ? new Date(sun.sr).getHours() : null;
    const ssH = sun.ss ? new Date(sun.ss).getHours() : null;
    for(let h=0;h<24;h++){
      const t=document.createElement('div'); t.className='tick';
      if(srH!==null && ssH!==null){ t.textContent = h===srH?'üåÖ':(h===ssH?'üåá':(h>srH && h<ssH ? '‚òÄÔ∏è':'üåô')); } else t.textContent=' ';
      sunAxis.appendChild(t);
    }
    if(sun.srStr||sun.ssStr){ sub.textContent += \` ¬∑ ‚Üë \${sun.srStr} ‚Üì \${sun.ssStr}\`; }
  }

  function buildDayCards(provider, locLabel){
    const list=document.getElementById('days'); list.innerHTML='';
    for(let i=0;i<10;i++){
      const date=new Date(); date.setDate(date.getDate()+i);
      const hours = provider.getDay(i) || Array(24).fill(0.2);
      const dailyAgg = Math.max(...hours); const pct=Math.round(dailyAgg*100);
      const ticks = Array.from({length:24},(_,h)=>\`<div>\${h%3===0?String(h).padStart(2,'0'):''}</div>\`).join('');
      const miniBars = hours.map((p,h)=>{ const w=Math.round(p*100); const c=p>=0.7?'var(--bad)':(p>=0.4?'var(--warn)':'var(--ok)'); return \`<div class="hbar" title="\${String(h).padStart(2,'0')}:00 ‚Äî \${w}%"><span style="width:\${w}%;background:\${c}"></span></div>\`; }).join('');
      const sun = provider.getSun ? provider.getSun(i) : {srStr:'‚Äî',ssStr:'‚Äî'};
      const card=document.createElement('div'); card.className='day'; card.setAttribute('role','listitem'); card.setAttribute('tabindex','0');
      card.innerHTML = \`
        <div style="display:flex;justify-content:space-between"><strong>\${formatDayLabel(date)}</strong><div>\${riskIcon(dailyAgg)}</div></div>
        <div style="display:flex;justify-content:space-between"><span class="muted">Aggregated fog risk</span><span class="risk \${riskClass(dailyAgg)}">\${pct}%</span></div>
        <div class="bar"><span style="width:\${pct}%;background:\${dailyAgg>=0.7?'var(--bad)':(dailyAgg>=0.4?'var(--warn)':'var(--ok)')}"></span></div>
        <div class="mini-hourly"><div class="ticks">\${ticks}</div><div class="cols">\${miniBars}</div></div>
        <div style="display:flex;justify-content:space-between"><span class="pill">\${locLabel}</span><span class="small">‚Üë \${sun.srStr} ‚Ä¢ ‚Üì \${sun.ssStr}</span></div>\`;
      function select(){document.querySelectorAll('.day').forEach(d=>d.classList.remove('selected')); card.classList.add('selected'); renderHourly(locLabel,date,hours,provider);}
      card.addEventListener('click', select); card.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); select(); }});
      if(i===0) setTimeout(select,0);
      list.appendChild(card);
    }
  }

  async function buildDays(){
    clearStatus();
    const q=document.getElementById('location').value.trim();
    if(!q){ tell('err','Enter a place'); alert('Enter a place'); return; }
    tell('info', 'Geocoding‚Ä¶');
    let g=null;
    try{ g=await geocodePlace(q); tell('ok', 'Geocoding OK: '+g.label); }
    catch(e){ tell('err', 'Geocoding failed. '+e.message+' ‚Äî try a simpler place name (e.g., London)'); return; }
    tell('info', 'Fetching forecast‚Ä¶');
    let provider=null;
    try{ provider=await openMeteo({lat:g.lat, lon:g.lon, timezone:g.timezone}); tell('ok','Forecast OK'); }
    catch(e){ tell('err','Forecast failed. '+e.message+' ‚Äî GitHub Pages should be HTTPS; check browser extensions / network.'); return; }
    buildDayCards(provider, g.label);
    tell('ok','Done.');
  }

  function showGeo(){ const b=document.getElementById('geoBanner'); if(b) b.hidden=false; }
  function useGeo(){
    if(!('geolocation' in navigator)){ tell('err','Geolocation not supported (needs HTTPS).'); alert('Geolocation not supported'); return; }
    navigator.geolocation.getCurrentPosition(async(pos)=>{
      const label=\`\${pos.coords.latitude.toFixed(4)}, \${pos.coords.longitude.toFixed(4)}\`;
      document.getElementById('location').value=label; buildDays();
    }, (err)=>{ tell('err','Location failed: '+(err?.message||'Permission denied')); alert('Location failed: '+(err?.message||'Permission denied')); }, {timeout:8000,maximumAge:300000});
  }

  async function selfCheck(){
    clearStatus();
    tell('info', 'Running deploy self‚Äëcheck‚Ä¶');
    const isHttps = location.protocol === 'https:';
    tell(isHttps?'ok':'err', (isHttps?'‚úì':'‚úó')+' Page served over '+location.protocol);
    try{
      const pong = await fetch('https://geocoding-api.open-meteo.com/v1/search?name=London&count=1&language=en&format=json',{mode:'cors'}).then(r=>r.ok? r.json():Promise.reject(r.status));
      tell(pong?.results?.length? 'ok':'err', (pong?.results?.length? '‚úì':'‚úó')+' Geocoding fetch');
    }catch(e){ tell('err','‚úó Geocoding fetch blocked'); }
    try{
      const params=new URLSearchParams({latitude:51.5, longitude:-0.12, timezone:'auto', forecast_days:'1', hourly:'temperature_2m', daily:'sunrise,sunset'});
      const url=\`https://api.open-meteo.com/v1/forecast?\${params}\`;
      const pong = await fetch(url,{mode:'cors'}).then(r=>r.ok? r.json():Promise.reject(r.status));
      tell(pong?.hourly?.time? 'ok':'err', (pong?.hourly?.time? '‚úì':'‚úó')+' Forecast fetch');
    }catch(e){ tell('err','‚úó Forecast fetch blocked'); }
    tell('info','If anything is ‚úó, try disabling strict ad‚Äëblockers for this page, then reload.');
  }

  document.getElementById('go').addEventListener('click', buildDays);
  document.getElementById('useGeo').addEventListener('click', useGeo);
  document.getElementById('geoAllow').addEventListener('click', ()=>{ sessionStorage.setItem(GEO_PROMPTED,'1'); localStorage.setItem(GEO_APPROVED,'1'); document.getElementById('geoBanner').hidden=true; useGeo(); });
  document.getElementById('geoDismiss').addEventListener('click', ()=>{ sessionStorage.setItem(GEO_PROMPTED,'1'); document.getElementById('geoBanner').hidden=true; });
  document.getElementById('selfTest').addEventListener('click', selfCheck);

  (function(){ const approved=localStorage.getItem(GEO_APPROVED); const prompted=sessionStorage.getItem(GEO_PROMPTED); if(approved){ useGeo(); } else if(!prompted){ showGeo(); } })();

  // Initial build with default placeholder
  buildDays();
  </script>
</body>
</html>
